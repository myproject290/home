<!DOCTYPE html>    <html>    
<head>    
<meta charset="utf-8">    
<title>Enrollment</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23007bff%22/><text x=%2250%22 y=%2250%22 font-size=%2270%22 fill=%22white%22 font-family=%22Arial, sans-serif%22 font-weight=%22bold%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>E</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23007bff%22/><text x=%2250%22 y=%2250%22 font-size=%2270%22 fill=%22white%22 font-family=%22Arial, sans-serif%22 font-weight=%22bold%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>E</text></svg>">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
<style>    
html, body { overscroll-behavior-y: auto; }    
body{font-family:Arial;margin:0;padding:5px; overflow-x: auto;}    
#topbar{display:flex;gap:8px;justify-content:center;margin-bottom:8px;flex-wrap:wrap;background:#f8f9fa;padding:10px;border-radius:8px; width: fit-content; min-width: 100%;}    
.topbtn{padding:6px 12px;font-size:14px;cursor:pointer;border:1px solid #ccc;background:#fff;border-radius:4px;display:flex;align-items:center;gap:5px;transition: all 0.3s ease;}
.topbtn span{
    font-size:16px;
    line-height:1;
}        
#title{text-align:center;font-size:25px;font-weight:bold;margin:5px 0;outline:none;}    

/* --- Table Base Style --- */
table {
    border-collapse: collapse; 
    min-width: 900px; 
    table-layout: fixed; 
    margin: 10px auto;
    border-right: 0.5px solid #000; 
}

td, th { 
    border: 0.5px solid #000; 
    text-align:center; 
    padding:1px; 
    font-size:20px; 
    height:32px; 
    overflow: hidden; 
}

.classcol, .label{ width:140px !important; }
.delcol{width:40px}
th:not(.classcol):not(.delcol), td:not(.classcol):not(.delcell) { width: 45px; }

.edit{background:#fff; outline: none;}
.edit:focus{background:#fffbe6; border: 2px solid blue !important;}

#pre td, #pri td, #grand td { color: red; font-weight: bold; }
.sc-t,.st-t,.obc-t,.gen-t,.tt{color:red;font-weight:bold}
.head-t{color:red;font-weight:bold}
.label{ color:red; font-weight:bold; white-space:normal; line-height:1.2; font-size:20px; }
.delcell button{border:none;background:none;font-size:18px;cursor:pointer;color:black}
.hidepdf{display:none}
#pri td{height:45px; background-color:#fff;}
#pre td{height:auto !important; background-color:#fff;}

.pdfmode td, .pdfmode th { border: 0.5px solid #000 !important; }
.pdfmode table { 
    border-right: 0.5px solid #000 !important;
    outline: 0.1px solid rgba(0,0,0,0.05); 
}
.pdfmode { padding: 5px !important; background: white; }

@media print {
    #topbar { display:none; }
    .delcol, .delcell { display:none; }
    table { border-right: 2px solid #000 !important; }
    th:last-child, td:last-child { border-right: 2px solid #000 !important; }
}
/* ================= BODY + SECOND HEADER ROW ================= */

/* SC */
#mainTable tr td:nth-child(3){
  border-left:1.125pt solid #000!important;
}
#mainTable tr th:nth-child(3),
#mainTable tr td:nth-child(5){
  border-right:1.125pt solid #000!important;
}

/* ST */
#mainTable tr th:nth-child(4),
#mainTable tr td:nth-child(6){
  border-left:1.125pt solid #000!important;
}
#mainTable tr th:nth-child(6),
#mainTable tr td:nth-child(8){
  border-right:1.125pt solid #000!important;
}

/* OBC */
#mainTable tr th:nth-child(7),
#mainTable tr td:nth-child(9){
  border-left:1.125pt solid #000!important;
}
#mainTable tr th:nth-child(9),
#mainTable tr td:nth-child(11){
  border-right:1.125pt solid #000!important;
}

/* GEN */
#mainTable tr th:nth-child(10),
#mainTable tr td:nth-child(12){
  border-left:1.125pt solid #000!important;
}
#mainTable tr th:nth-child(12),
#mainTable tr td:nth-child(14){
  border-right:1.125pt solid #000!important;
}

/* TOTAL */
#mainTable tr th:nth-child(13),
#mainTable tr td:nth-child(15){
  border-left:1.125pt solid #000!important;
}
#mainTable tr th:nth-child(15),
#mainTable tr td:nth-child(17){
  border-right:1.125pt solid #000!important;
}

/* ===== FIRST HEADER ROW (SC ST OBC GEN TOTAL) ===== */

thead tr:first-child th:nth-child(3),
thead tr:first-child th:nth-child(4),
thead tr:first-child th:nth-child(5),
thead tr:first-child th:nth-child(6),
thead tr:first-child th:nth-child(7){
  border-left:1.125pt solid #000!important;
  border-right:1.125pt solid #000!important;
}
/* Restore thick border at SC-B start */

#mainTable thead tr:nth-child(2) th:first-child,
#mainTable tbody td:nth-child(3){
  border-left:1.125pt solid #000 !important;
}
/* ===== Thick TOP border (excluding Ã— column) ===== */

#mainTable thead tr:first-child th:not(.delcol){
  border-top:1.125pt solid #000 !important;
}

/* ===== Thick BOTTOM border (excluding Ã— column) ===== */

#mainTable tbody tr:last-child td:not(.delcell){
  border-bottom:1.125pt solid #000 !important;
}
/* Thick left border for Class column (not Ã— column) */

#mainTable th.classcol,
#mainTable td.classcol,
#mainTable td.label{
  border-left:1.125pt solid #000 !important;
}
/* Bottom thick line under B G T row INCLUDING Class column (exclude Ã—) */

/* Class header (rowspan cell) */
#mainTable thead tr:first-child th.classcol{
  border-bottom:1.125pt solid #000 !important;
}

/* All B G T cells */
#mainTable thead tr:nth-child(2) th{
  border-bottom:1.125pt solid #000 !important;
}
/* Total (Pre-Primary): top + bottom (exclude Ã— column) */
#mainTable tr#pre td:not(.delcell){
  border-top:1.125pt solid #000 !important;
  border-bottom:1.125pt solid #000 !important;
}

/* Total (Primary): bottom only (exclude Ã— column) */
#mainTable tr#pri td:not(.delcell){
  border-bottom:1.125pt solid #000 !important;
}
</style>

</head>    
<body>    
<div id="topbar">    
<button class="topbtn" onclick="undoAction()"><span>&#8634;</span> Undo</button>    
<button class="topbtn" onclick="redoAction()"><span>&#8635;</span> Redo</button>    
<div style="width:1px; background:#ccc; margin:0 10px;"></div>    
<button class="topbtn" id="zeroBtn" onclick="toggleZeros()"><span>&#9678;</span> Hide 0</button>
<button class="topbtn" onclick="printPDF()">Print/ Save as PDF</button>    
<button class="topbtn" id="shareBtn" onclick="shareAsPDF()">Share PDF</button>    
<button class="topbtn" id="downloadBtn" onclick="makePDF()">Download PDF</button>    
<button class="topbtn" id="saveBtn" onclick="saveToLocal(true)">Save</button>    
<button class="topbtn" id="resetBtn" onclick="resetForm()">Reset</button>    
</div>    

<div id="pdfArea">    
<div id="title" contenteditable="true" spellcheck="false">Enrollment</div>    
<table id="mainTable">    
  <thead>    
    <tr>    
      <th class="delcol" rowspan="2"></th>    
      <th class="classcol" rowspan="2">Class</th>    
      <th colspan="3">SC</th>    
      <th colspan="3">ST</th>    
      <th colspan="3">OBC</th>    
      <th colspan="3">Gen.</th>    
      <th colspan="3">Total</th>    
    </tr>    
    <tr>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
    </tr>    
  </thead>    
  <tbody id="rows"></tbody>    
  </table>    
</div>    

<script>    
let undoStack = [];    
let redoStack = [];    
let isDataEntered = false;     
let zerosHidden = false; 
const classes=[["Nursery","pre"],["LKG","pre"],["UKG","pre"],["TOTAL PRE-PRI","total-pre"],["I","pri"],["II","pri"],["III","pri"],["IV","pri"],["V","pri"]];    

function flashButton(btnId, tempText) {    
    const btn = document.getElementById(btnId);    
    if (!btn) return;    
    const oldHTML = btn.innerHTML;    
    btn.innerHTML = tempText;    
    setTimeout(() => { btn.innerHTML = oldHTML; }, 2000);    
}    
  
function saveState() {    
    undoStack.push(document.getElementById("pdfArea").innerHTML);    
    if (undoStack.length > 30) undoStack.shift();    
    redoStack = [];    
}    
  
function undoAction() {    
    if (undoStack.length > 0) {    
        redoStack.push(document.getElementById("pdfArea").innerHTML);    
        document.getElementById("pdfArea").innerHTML = undoStack.pop();    
        isDataEntered = true;  
        attachEvents();    
        setTimeout(()=>calc(),50);    
    }    
}  
  
function redoAction() {    
    if (redoStack.length > 0) {    
        undoStack.push(document.getElementById("pdfArea").innerHTML);    
        document.getElementById("pdfArea").innerHTML = redoStack.pop();    
        isDataEntered = true;  
        attachEvents();    
        setTimeout(()=>calc(),50);    
    }    
}  
  
function attachEvents() {    
    document.querySelectorAll(".edit, #title").forEach(el => {    
        el.onfocus = () => saveState();    
        if(el.classList.contains('edit')){    
            el.addEventListener('keydown', (e) => {    
                if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 || (e.keyCode >= 35 && e.keyCode <= 39)) return;    
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) e.preventDefault();    
            });    
            el.addEventListener('input', (e) => {    
                let clean = el.innerText.replace(/[^\d]/g, '');    
                if (el.innerText !== clean) {    
                    el.innerText = clean;    
                    const range = document.createRange();    
                    const sel = window.getSelection();    
                    range.selectNodeContents(el);    
                    range.collapse(false);    
                    sel.removeAllRanges();    
                    sel.addRange(range);    
                }    
                isDataEntered = true; calc(); saveToLocal(false);     
            });    
        } else {    
            el.oninput = () => { isDataEntered = true; saveToLocal(false); };    
        }    
    });    
}    
  
function deleteRow(btn) {    
    saveState();    
    btn.closest('tr').remove();    
    calc();    
    saveToLocal(false);    
}    
  
function n(x){return x ? (parseInt(x.innerText)||0) : 0}    
  
function setVal(el, value) {    
    if(!el) return;    
    el.innerText = (isDataEntered) ? value : "";    
}    

function toggleZeros() {
    zerosHidden = !zerosHidden;
    updateZeroButtonUI();
    calc();
}

function updateZeroButtonUI() {
    const btn = document.getElementById("zeroBtn");
    if (!btn) return;
    if (zerosHidden) {
        btn.innerHTML = "<span>&#128065;</span> Show 0"; 
    } else {
        btn.innerHTML = "<span>&#9678;</span> Hide 0"; 
    }
}

function calc(){    
  document.querySelectorAll(".row").forEach(r=>{    
    let sb=n(r.querySelector(".sc-b")), sg=n(r.querySelector(".sc-g")), stb=n(r.querySelector(".st-b")), stg=n(r.querySelector(".st-g")), ob=n(r.querySelector(".obc-b")), og=n(r.querySelector(".obc-g")), gb=n(r.querySelector(".gen-b")), gg=n(r.querySelector(".gen-g"));    
    setVal(r.querySelector(".sc-t"), sb+sg); setVal(r.querySelector(".st-t"), stb+stg);    
    setVal(r.querySelector(".obc-t"), ob+og); setVal(r.querySelector(".gen-t"), gb+gg);    
    setVal(r.querySelector(".tb"), sb+stb+ob+gb); setVal(r.querySelector(".tg"), sg+stg+og+gg);    
    setVal(r.querySelector(".tt"), (sb+sg)+(stb+stg)+(ob+og)+(gb+gg));    
  });    
  
  ["pre","pri"].forEach(id=>{    
    let sumRow = document.getElementById(id);   
    if(!sumRow) return;    
    let dataRows = document.querySelectorAll(".row."+id);    
    ["sc-b","sc-g","sc-t","st-b","st-g","st-t","obc-b","obc-g","obc-t","gen-b","gen-g","gen-t","tb","tg","tt"].forEach(c=>{    
      let t=0; dataRows.forEach(r=> t+=n(r.querySelector("."+c)));     
      setVal(sumRow.querySelector("."+c), t);    
    });    
  });    
  
  let grand = document.getElementById("grand");  
  if(grand) {  
    let allDataRows = document.querySelectorAll(".row");  
    ["sc-b","sc-g","sc-t","st-b","st-g","st-t","obc-b","obc-g","obc-t","gen-b","gen-g","gen-t","tb","tg","tt"].forEach(c=>{    
        let totalVal = 0;  
        allDataRows.forEach(r => totalVal += n(r.querySelector("."+c)));  
        setVal(grand.querySelector("."+c), totalVal);    
    });  
  }

  // TOTAL rows + TOTAL columns me hi Hide 0
const totalCells = document.querySelectorAll(`
#mainTable td.sc-t,
#mainTable td.st-t,
#mainTable td.obc-t,
#mainTable td.gen-t,
#mainTable td.tb,
#mainTable td.tg,
#mainTable td.tt,
#pre td,
#pri td,
#grand td
`);

totalCells.forEach(td => {
    let v = parseInt(td.innerText.trim());

    if (zerosHidden && v === 0) {
        td.style.color = "transparent";
    } else {
        td.style.color = "";
    }
});
}    
  
function buildTable(){    
  const rows=document.getElementById("rows");    
  rows.innerHTML = "";    
  classes.forEach(c=>{    
    if(c[1] === "total-pre") {    
      rows.insertAdjacentHTML("beforeend",`<tr id="pre"><td class="delcell"><button onclick="deleteRow(this)">Ã—</button></td><td class="label">Total<br>(Pre-Primary)</td><td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td><td class="st-b"></td><td class="st-g"></td><td class="st-t"></td><td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td><td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td><td class="tb"></td><td class="tg"></td><td class="tt"></td></tr>`);    
    } else {    
      rows.insertAdjacentHTML("beforeend",`<tr class="row ${c[1]}"><td class="delcell"><button onclick="deleteRow(this)">Ã—</button></td><td class="classcol">${c[0]}</td><td class="sc-b edit" contenteditable="true" inputmode="numeric"></td><td class="sc-g edit" contenteditable="true" inputmode="numeric"></td><td class="sc-t"></td><td class="st-b edit" contenteditable="true" inputmode="numeric"></td><td class="st-g edit" contenteditable="true" inputmode="numeric"></td><td class="st-t"></td><td class="obc-b edit" contenteditable="true" inputmode="numeric"></td><td class="obc-g edit" contenteditable="true" inputmode="numeric"></td><td class="obc-t"></td><td class="gen-b edit" contenteditable="true" inputmode="numeric"></td><td class="gen-g edit" contenteditable="true" inputmode="numeric"></td><td class="gen-t"></td><td class="tb"></td><td class="tg"></td><td class="tt"></td></tr>`);    
    }    
  });    
    
  const table = document.getElementById("mainTable");  
  if(document.getElementById("pri")) document.getElementById("pri").remove();  
  if(document.getElementById("grand")) document.getElementById("grand").remove();  
  
  const footerHTML = `  
    <tr id="pri">    
      <td class="delcell"><button onclick="deleteRow(this)">Ã—</button></td>    
      <td class="label">Total<br>(Primary)</td>    
      <td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td>    
      <td class="st-b"></td><td class="st-g"></td><td class="st-t"></td>    
      <td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td>    
      <td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td>    
      <td class="tb"></td><td class="tg"></td><td class="tt"></td>    
    </tr>    
    <tr id="grand">    
      <td class="delcell"></td>    
      <td class="label">Grand Total</td>    
      <td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td>    
      <td class="st-b"></td><td class="st-g"></td><td class="st-t"></td>    
      <td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td>    
      <td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td>    
      <td class="tb"></td><td class="tg"></td><td class="tt"></td>    
    </tr>`;  
  table.insertAdjacentHTML("beforeend", footerHTML);  
  attachEvents();    
}    
  
function saveToLocal(manual){    
    localStorage.setItem("goshwara_data", document.getElementById("pdfArea").innerHTML);    
    localStorage.setItem("isDataEntered", isDataEntered);     
    localStorage.setItem("zerosHidden", zerosHidden); 
    if(manual) flashButton("saveBtn", "Saved! âœ…");    
}    
  
function resetForm(){    
    saveState();    
    isDataEntered = false;     
    zerosHidden = false; 
    localStorage.removeItem("goshwara_data");    
    localStorage.removeItem("isDataEntered");    
    localStorage.removeItem("zerosHidden");
    document.getElementById("title").innerText = "Enrollment";    
    buildTable();    
    updateZeroButtonUI();
    calc();    
    flashButton("resetBtn", "Cleared! ðŸ§¹");    
}    
  
async function generatePDFFile() {    
    const area = document.getElementById("pdfArea");    
    area.classList.add("pdfmode");    
    document.querySelectorAll(".delcell,.delcol").forEach(e=>e.classList.add("hidepdf"));    
    const canvas = await html2canvas(area, { scale: 2, useCORS: true });    
    area.classList.remove("pdfmode");    
    document.querySelectorAll(".delcell,.delcol").forEach(e=>e.classList.remove("hidepdf"));    
    const imgData = canvas.toDataURL("image/jpeg", 1.0);    
    const pdf = new jspdf.jsPDF("p", "mm", "a4");    
    const pageWidth = pdf.internal.pageSize.getWidth();    
    const marginX = 1;   
    const marginTop = 10; 
    const innerWidth = pageWidth - (marginX * 2);
    const imgWidth = innerWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    pdf.addImage(imgData, "JPEG", marginX, marginTop, imgWidth, imgHeight, undefined, "FAST");    
    return pdf;    
}    
  
async function shareAsPDF() {  
    const title = document.getElementById("title").innerText;  
    const btn = document.getElementById("shareBtn");  
    const oldHTML = btn.innerHTML;  
    btn.innerHTML = "Generating...";  
    
    try {  
        const pdf = await generatePDFFile();  
        const pdfBlob = pdf.output('blob');  
        const file = new File([pdfBlob], `${title}.pdf`, { type: 'application/pdf' });  
        
        btn.innerHTML = oldHTML; 

        if (navigator.canShare && navigator.canShare({ files: [file] })) {  
            await navigator.share({ files: [file], title: title });  
        } else {  
            alert("Permission denied");  
        }  
    } catch (err) { 
        btn.innerHTML = oldHTML;
        alert("Permission denied");
    }
}  
  
async function makePDF(){    
  const title = document.getElementById("title").innerText;    
  try {    
      const pdf = await generatePDFFile();    
      pdf.save(`${title}.pdf`);    
      flashButton("downloadBtn", "Downloaded! âœ…");    
  } catch (err) { console.error(err); }    
}    
  
function printPDF(){ document.title=document.getElementById("title").innerText; window.print(); }    
  
window.onload = () => {    
    let d = localStorage.getItem("goshwara_data");    
    isDataEntered = localStorage.getItem("isDataEntered") === "true";    
    let savedZeros = localStorage.getItem("zerosHidden");
    if (savedZeros !== null) { zerosHidden = (savedZeros === "true"); }
    if(d) { document.getElementById("pdfArea").innerHTML = d; attachEvents(); }     
    else { buildTable(); }    
    updateZeroButtonUI(); 
    calc();     
};    
</script>    
</body>    
</html>
