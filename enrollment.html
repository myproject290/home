<!DOCTYPE html>    <html>    
<head>    
<meta charset="utf-8">    
<title>Enrollment</title>    
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>  
<style>    
html, body { overscroll-behavior-y: contain; }    
body{font-family:Arial;margin:0;padding:5px; overflow-x: auto;}    
#topbar{display:flex;gap:8px;justify-content:center;margin-bottom:8px;flex-wrap:wrap;background:#f8f9fa;padding:10px;border-radius:8px; width: fit-content; min-width: 100%;}    
.topbtn{padding:6px 12px;font-size:14px;cursor:pointer;border:1px solid #ccc;background:#fff;border-radius:4px;display:flex;align-items:center;gap:5px;transition: all 0.3s ease;}    
.btn-active { background-color: #28a745 !important; color: white !important; border-color: #1e7e34 !important; }    
#title{text-align:center;font-size:26px;font-weight:bold;margin:5px 0;outline:none;}    

/* --- Table Base Style (Web View: 0.5px) --- */
table {
    border-collapse: collapse; 
    min-width: 900px; 
    table-layout: fixed; 
    margin: 10px auto;
    border-right: 0.5px solid #000; 
}

td, th { 
    border: 0.5px solid #000; 
    text-align:center; 
    padding:1px; 
    font-size:20px; 
    height:32px; 
    overflow: hidden; 
}

.classcol, .label{ width:140px !important; }
.delcol{width:40px}
th:not(.classcol):not(.delcol), td:not(.classcol):not(.delcell) { width: 45px; }

.edit{background:#fff; outline: none;}
.edit:focus{background:#fffbe6; border: 2px solid blue !important;}

#pre td, #pri td, #grand td { color: red; font-weight: bold; }
.sc-t,.st-t,.obc-t,.gen-t,.tt{color:red;font-weight:bold}
.head-t{color:red;font-weight:bold}
.label{ color:red; font-weight:bold; white-space:normal; line-height:1.2; font-size:20px; }
.delcell button{border:none;background:none;font-size:18px;cursor:pointer;color:black}
.hidepdf{display:none}
#pri td{height:45px; background-color:#fff;}
#pre td{height:auto !important; background-color:#fff;}

/* --- Share & Download PDF Mode (Sharp 0.5px) --- */
.pdfmode td, .pdfmode th { border: 0.5px solid #000 !important; }
.pdfmode table { 
    border-right: 0.5px solid #000 !important;
    outline: 0.1px solid rgba(0,0,0,0.05); 
}
.pdfmode { padding: 20px !important; background: white; }

/* --- Ctrl + P Print Mode --- */
@media print {
    #topbar { display:none; }
    .delcol, .delcell { display:none; }
    table { border-right: 2px solid #000 !important; }
    th:last-child, td:last-child { border-right: 2px solid #000 !important; }
}
</style>

</head>    
<body>    
<div id="topbar">    
<button class="topbtn" onclick="undoAction()"><span>‚Ü©Ô∏è</span> Undo</button>    
<button class="topbtn" onclick="redoAction()"><span>‚Ü™Ô∏è</span> Redo</button>    
<div style="width:1px; background:#ccc; margin:0 10px;"></div>    
<button class="topbtn" onclick="printPDF()">Print/ Save as PDF</button>    
<button class="topbtn" id="shareBtn" onclick="shareAsPDF()">Share PDF</button>    
<button class="topbtn" id="downloadBtn" onclick="makePDF()">Download PDF</button>    
<button class="topbtn" id="saveBtn" onclick="saveToLocal(true)">Save for future</button>    
<button class="topbtn" id="resetBtn" onclick="resetForm()">Reset</button>    
</div>    
<div id="pdfArea">    
<div id="title" contenteditable="true" spellcheck="false">Enrollment</div>    
<table id="mainTable">    
  <thead>    
    <tr>    
      <th class="delcol" rowspan="2"></th>    
      <th class="classcol" rowspan="2">Class</th>    
      <th colspan="3">SC</th>    
      <th colspan="3">ST</th>    
      <th colspan="3">OBC</th>    
      <th colspan="3">Gen.</th>    
      <th colspan="3">Total</th>    
    </tr>    
    <tr>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
      <th>B</th><th>G</th><th class="head-t">T</th>    
    </tr>    
  </thead>    
  <tbody id="rows"></tbody>    
  </table>    
</div>    

<script>    
let undoStack = [];    
let redoStack = [];    
let isDataEntered = false;     
const classes=[["Nursery","pre"],["LKG","pre"],["UKG","pre"],["TOTAL PRE-PRI","total-pre"],["I","pri"],["II","pri"],["III","pri"],["IV","pri"],["V","pri"]];    
  
function flashButton(btnId, tempText) {    
    const btn = document.getElementById(btnId);    
    if (!btn) return;    
    const oldHTML = btn.innerHTML;    
    btn.classList.add("btn-active");    
    btn.innerText = tempText;    
    setTimeout(() => {    
        btn.classList.remove("btn-active");    
        btn.innerHTML = oldHTML;    
    }, 2000);    
}    
  
function saveState() {    
    undoStack.push(document.getElementById("pdfArea").innerHTML);    
    if (undoStack.length > 30) undoStack.shift();    
    redoStack = [];    
}    
  
function undoAction() {    
    if (undoStack.length > 0) {    
        redoStack.push(document.getElementById("pdfArea").innerHTML);    
        document.getElementById("pdfArea").innerHTML = undoStack.pop();    
        isDataEntered = true;  
        attachEvents();    
        setTimeout(()=>calc(),50);    
    }    
}  
  
function redoAction() {    
    if (redoStack.length > 0) {    
        undoStack.push(document.getElementById("pdfArea").innerHTML);    
        document.getElementById("pdfArea").innerHTML = redoStack.pop();    
        isDataEntered = true;  
        attachEvents();    
        setTimeout(()=>calc(),50);    
    }    
}  
  
function attachEvents() {    
    document.querySelectorAll(".edit, #title").forEach(el => {    
        el.onfocus = () => saveState();    
        if(el.classList.contains('edit')){    
            el.addEventListener('keydown', (e) => {    
                if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 || (e.keyCode >= 35 && e.keyCode <= 39)) return;    
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) e.preventDefault();    
            });    
            el.addEventListener('input', (e) => {    
                let clean = el.innerText.replace(/[^\d]/g, '');    
                if (el.innerText !== clean) {    
                    el.innerText = clean;    
                    const range = document.createRange();    
                    const sel = window.getSelection();    
                    range.selectNodeContents(el);    
                    range.collapse(false);    
                    sel.removeAllRanges();    
                    sel.addRange(range);    
                }    
                isDataEntered = true; calc(); saveToLocal(false);     
            });    
        } else {    
            el.oninput = () => { isDataEntered = true; saveToLocal(false); };    
        }    
    });    
}    
  
function deleteRow(btn) {    
    saveState();    
    btn.closest('tr').remove();    
    calc();    
    saveToLocal(false);    
}    
  
function n(x){return x ? (parseInt(x.innerText)||0) : 0}    
  
function setVal(el, value) {    
    if(!el) return;    
    el.innerText = (isDataEntered) ? value : "";    
}    
  
function calc(){    
  document.querySelectorAll(".row").forEach(r=>{    
    let sb=n(r.querySelector(".sc-b")), sg=n(r.querySelector(".sc-g")), stb=n(r.querySelector(".st-b")), stg=n(r.querySelector(".st-g")), ob=n(r.querySelector(".obc-b")), og=n(r.querySelector(".obc-g")), gb=n(r.querySelector(".gen-b")), gg=n(r.querySelector(".gen-g"));    
    setVal(r.querySelector(".sc-t"), sb+sg); setVal(r.querySelector(".st-t"), stb+stg);    
    setVal(r.querySelector(".obc-t"), ob+og); setVal(r.querySelector(".gen-t"), gb+gg);    
    setVal(r.querySelector(".tb"), sb+stb+ob+gb); setVal(r.querySelector(".tg"), sg+stg+og+gg);    
    setVal(r.querySelector(".tt"), (sb+sg)+(stb+stg)+(ob+og)+(gb+gg));    
  });    
  
  ["pre","pri"].forEach(id=>{    
    let sumRow = document.getElementById(id);   
    if(!sumRow) return;    
    let dataRows = document.querySelectorAll(".row."+id);    
    ["sc-b","sc-g","sc-t","st-b","st-g","st-t","obc-b","obc-g","obc-t","gen-b","gen-g","gen-t","tb","tg","tt"].forEach(c=>{    
      let t=0; dataRows.forEach(r=> t+=n(r.querySelector("."+c)));     
      setVal(sumRow.querySelector("."+c), t);    
    });    
  });    
  
  let grand = document.getElementById("grand");  
  if(grand) {  
    let allDataRows = document.querySelectorAll(".row");  
    ["sc-b","sc-g","sc-t","st-b","st-g","st-t","obc-b","obc-g","obc-t","gen-b","gen-g","gen-t","tb","tg","tt"].forEach(c=>{    
        let totalVal = 0;  
        allDataRows.forEach(r => totalVal += n(r.querySelector("."+c)));  
        setVal(grand.querySelector("."+c), totalVal);    
    });  
  }  
}    
  
function buildTable(){    
  const rows=document.getElementById("rows");    
  rows.innerHTML = "";    
  classes.forEach(c=>{    
    if(c[1] === "total-pre") {    
      rows.insertAdjacentHTML("beforeend",`<tr id="pre"><td class="delcell"><button onclick="deleteRow(this)">√ó</button></td><td class="label">Total<br>(Pre-Primary)</td><td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td><td class="st-b"></td><td class="st-g"></td><td class="st-t"></td><td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td><td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td><td class="tb"></td><td class="tg"></td><td class="tt"></td></tr>`);    
    } else {    
      rows.insertAdjacentHTML("beforeend",`<tr class="row ${c[1]}"><td class="delcell"><button onclick="deleteRow(this)">√ó</button></td><td class="classcol">${c[0]}</td><td class="sc-b edit" contenteditable="true" inputmode="numeric"></td><td class="sc-g edit" contenteditable="true" inputmode="numeric"></td><td class="sc-t"></td><td class="st-b edit" contenteditable="true" inputmode="numeric"></td><td class="st-g edit" contenteditable="true" inputmode="numeric"></td><td class="st-t"></td><td class="obc-b edit" contenteditable="true" inputmode="numeric"></td><td class="obc-g edit" contenteditable="true" inputmode="numeric"></td><td class="obc-t"></td><td class="gen-b edit" contenteditable="true" inputmode="numeric"></td><td class="gen-g edit" contenteditable="true" inputmode="numeric"></td><td class="gen-t"></td><td class="tb"></td><td class="tg"></td><td class="tt"></td></tr>`);    
    }    
  });    
    
  const table = document.getElementById("mainTable");  
  if(document.getElementById("pri")) document.getElementById("pri").remove();  
  if(document.getElementById("grand")) document.getElementById("grand").remove();  
  
  const footerHTML = `  
    <tr id="pri">    
      <td class="delcell"><button onclick="deleteRow(this)">√ó</button></td>    
      <td class="label">Total<br>(Primary)</td>    
      <td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td>    
      <td class="st-b"></td><td class="st-g"></td><td class="st-t"></td>    
      <td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td>    
      <td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td>    
      <td class="tb"></td><td class="tg"></td><td class="tt"></td>    
    </tr>    
    <tr id="grand">    
      <td class="delcell"></td>    
      <td class="label">Grand Total</td>    
      <td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td>    
      <td class="st-b"></td><td class="st-g"></td><td class="st-t"></td>    
      <td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td>    
      <td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td>    
      <td class="tb"></td><td class="tg"></td><td class="tt"></td>    
    </tr>`;  
  table.insertAdjacentHTML("beforeend", footerHTML);  
  
  attachEvents();    
}    
  
function saveToLocal(manual){    
    localStorage.setItem("goshwara_data", document.getElementById("pdfArea").innerHTML);    
    localStorage.setItem("isDataEntered", isDataEntered);     
    if(manual) flashButton("saveBtn", "Saved! ‚úÖ");    
}    
  
function resetForm(){    
    saveState();    
    isDataEntered = false;     
    localStorage.removeItem("goshwara_data");    
    localStorage.removeItem("isDataEntered");    
    document.getElementById("title").innerText = "Enrollment";    
    buildTable();    
    calc();    
    flashButton("resetBtn", "Cleared! üßπ");    
}    
  
async function generatePDFFile() {    
    const area = document.getElementById("pdfArea");    
    area.classList.add("pdfmode");    
    document.querySelectorAll(".delcell,.delcol").forEach(e=>e.classList.add("hidepdf"));    
    const canvas = await html2canvas(area, { scale: 2, useCORS: true });    
    area.classList.remove("pdfmode");    
    document.querySelectorAll(".delcell,.delcol").forEach(e=>e.classList.remove("hidepdf"));    
    const imgData = canvas.toDataURL("image/jpeg", 1.0);    
    const pdf = new jspdf.jsPDF("p", "mm", "a4");    
    const pageWidth = pdf.internal.pageSize.getWidth();    
    const margin = 5;     
    const innerWidth = pageWidth - (margin * 2);    
    const imgWidth = innerWidth;    
    const imgHeight = (canvas.height * imgWidth) / canvas.width;    
    pdf.addImage(imgData, "JPEG", margin, margin, imgWidth, imgHeight);    
    return pdf;    
}    
  
async function shareAsPDF() {  
    const title = document.getElementById("title").innerText;  
    const btn = document.getElementById("shareBtn");  
    const oldHTML = btn.innerHTML;  
    btn.classList.add("btn-active");  
    btn.innerText = "Generating...";  
      
    try {  
        const pdf = await generatePDFFile();  
        const pdfBlob = pdf.output('blob');  
        const file = new File([pdfBlob], `${title}.pdf`, { type: 'application/pdf' });  
          
        if (navigator.canShare && navigator.canShare({ files: [file] })) {  
            await navigator.share({ files: [file], title: title });  
            // Yahan share ho gaya ya menu khul gaya
        } else {  
            alert("Sharing not supported");  
        }  
    } catch (err) {   
        console.error(err);   
    } finally {
        // Ye hamesha button ko wapas normal kar dega
        btn.classList.remove("btn-active");  
        btn.innerHTML = oldHTML;  
    }
}  
  
async function makePDF(){    
  const title = document.getElementById("title").innerText;    
  try {    
      const pdf = await generatePDFFile();    
      pdf.save(`${title}.pdf`);    
      flashButton("downloadBtn", "Downloaded! ‚úÖ");    
  } catch (err) { console.error(err); }    
}    
  
function printPDF(){ document.title=document.getElementById("title").innerText; window.print(); }    
  
window.onload = () => {    
    let d = localStorage.getItem("goshwara_data");    
    isDataEntered = localStorage.getItem("isDataEntered") === "true";    
    if(d) { document.getElementById("pdfArea").innerHTML = d; attachEvents(); }     
    else { buildTable(); }    
    calc();     
};    
</script>    
</body>    
</html>


