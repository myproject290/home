<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Enrollment</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:0;padding:5px}

#topbar{
display:flex;
gap:8px;
justify-content:center;
margin-bottom:8px;
flex-wrap:wrap;
}

.topbtn{padding:6px 10px;font-size:14px;cursor:pointer}

#title{
text-align:center;
font-size:26px;
font-weight:bold;
margin:5px 0;
outline:none;
}

table{border-collapse:collapse;width:100%;table-layout:fixed}

td,th{
border:2px solid #000;
text-align:center;
padding:0;
font-size:18px;
height:32px;
overflow:hidden;
}

.classcol{width:150px}
.delcol{width:30px}

.edit{background:#fff}

/* BODY T red */
.sc-t,.st-t,.obc-t,.gen-t,.tt{color:red;font-weight:bold}

/* HEADER T red */
.head-t{color:red;font-weight:bold}

.label{color:red;font-weight:bold;white-space:normal;line-height:1.2}

.delcell button{border:none;background:none;font-size:18px;cursor:pointer}

.hidepdf{display:none}

/* taller total rows */
#pre td,#pri td{height:45px}

/* PDF clean borders */
.pdfmode td,.pdfmode th{
border:1px solid #000 !important;
outline:none !important;
}
.pdfmode .edit{caret-color:transparent}

@media print{
#topbar{display:none}
.delcol,.delcell{display:none}
}
</style>
</head>

<body>

<div id="topbar">
<button class="topbtn" onclick="printPDF()">Print/ Save as PDF</button>
<button class="topbtn" onclick="makePDF('share')">Share as PDF</button>
<button class="topbtn" onclick="makePDF('download')">Download PDF</button>
<button class="topbtn" id="saveBtn" onclick="saveData()">Save for Future</button>
<button class="topbtn" id="resetBtn" onclick="resetForm()">Reset</button>
</div>

<div id="pdfArea">

<div id="title" contenteditable="true">Enrollment</div>

<table>

<tr>
<th class="delcol" rowspan="2"></th>
<th class="classcol" rowspan="2">Class</th>
<th colspan="3">SC</th>
<th colspan="3">ST</th>
<th colspan="3">OBC</th>
<th colspan="3">GEN</th>
<th colspan="3">TOTAL</th>
</tr>

<tr>
<th>B</th><th>G</th><th class="head-t">T</th>
<th>B</th><th>G</th><th class="head-t">T</th>
<th>B</th><th>G</th><th class="head-t">T</th>
<th>B</th><th>G</th><th class="head-t">T</th>
<th>B</th><th>G</th><th class="head-t">T</th>
</tr>

<tbody id="rows"></tbody>

<tr id="pre">
<td class="delcell"><button onclick="this.closest('tr').remove();calc()">×</button></td>
<td class="label">Total<br>(Pre-Primary)</td>
<td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td>
<td class="st-b"></td><td class="st-g"></td><td class="st-t"></td>
<td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td>
<td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td>
<td class="tb"></td><td class="tg"></td><td class="tt"></td>
</tr>

<tr id="pri">
<td class="delcell"><button onclick="this.closest('tr').remove();calc()">×</button></td>
<td class="label">Total<br>(Primary)</td>
<td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td>
<td class="st-b"></td><td class="st-g"></td><td class="st-t"></td>
<td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td>
<td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td>
<td class="tb"></td><td class="tg"></td><td class="tt"></td>
</tr>

<tr id="grand">
<td class="delcell"></td>
<td class="label">Grand Total</td>
<td class="sc-b"></td><td class="sc-g"></td><td class="sc-t"></td>
<td class="st-b"></td><td class="st-g"></td><td class="st-t"></td>
<td class="obc-b"></td><td class="obc-g"></td><td class="obc-t"></td>
<td class="gen-b"></td><td class="gen-g"></td><td class="gen-t"></td>
<td class="tb"></td><td class="tg"></td><td class="tt"></td>
</tr>

</table>
</div>

<script>
function getFileName(){
let t=document.getElementById("title").innerText.trim();
return t?t.replace(/\s+/g," "):"Enrollment";
}

function printPDF(){
document.title=getFileName();
window.print();
}

const classes=[
["Nursery","pre"],["LKG","pre"],["UKG","pre"],
["I","pri"],["II","pri"],["III","pri"],["IV","pri"],["V","pri"]
];

const rows=document.getElementById("rows");

classes.forEach(c=>{
rows.insertAdjacentHTML("beforeend",`
<tr class="row ${c[1]}">
<td class="delcell"><button onclick="this.closest('tr').remove();calc()">×</button></td>
<td class="classcol">${c[0]}</td>
<td class="sc-b edit" contenteditable></td>
<td class="sc-g edit" contenteditable></td>
<td class="sc-t"></td>
<td class="st-b edit" contenteditable></td>
<td class="st-g edit" contenteditable></td>
<td class="st-t"></td>
<td class="obc-b edit" contenteditable></td>
<td class="obc-g edit" contenteditable></td>
<td class="obc-t"></td>
<td class="gen-b edit" contenteditable></td>
<td class="gen-g edit" contenteditable></td>
<td class="gen-t"></td>
<td class="tb"></td><td class="tg"></td><td class="tt"></td>
</tr>`);
});

function n(x){return parseInt(x.innerText)||0}

function calc(){
document.querySelectorAll(".row").forEach(r=>{
let sb=n(r.querySelector(".sc-b")),sg=n(r.querySelector(".sc-g"));
let stb=n(r.querySelector(".st-b")),stg=n(r.querySelector(".st-g"));
let ob=n(r.querySelector(".obc-b")),og=n(r.querySelector(".obc-g"));
let gb=n(r.querySelector(".gen-b")),gg=n(r.querySelector(".gen-g"));

r.querySelector(".sc-t").innerText=sb+sg;
r.querySelector(".st-t").innerText=stb+stg;
r.querySelector(".obc-t").innerText=ob+og;
r.querySelector(".gen-t").innerText=gb+gg;

r.querySelector(".tb").innerText=sb+stb+ob+gb;
r.querySelector(".tg").innerText=sg+stg+og+gg;
r.querySelector(".tt").innerText=
n(r.querySelector(".sc-t"))+
n(r.querySelector(".st-t"))+
n(r.querySelector(".obc-t"))+
n(r.querySelector(".gen-t"));
});

["pre","pri"].forEach(id=>{
let sum=document.getElementById(id);
if(!sum)return;
let rs=document.querySelectorAll("."+id);
["sc-b","sc-g","sc-t","st-b","st-g","st-t","obc-b","obc-g","obc-t","gen-b","gen-g","gen-t","tb","tg","tt"]
.forEach(c=>{
let t=0;rs.forEach(r=>t+=n(r.querySelector("."+c)));
sum.querySelector("."+c).innerText=t;
});
});

let pre=document.getElementById("pre");
let pri=document.getElementById("pri");
let grand=document.getElementById("grand");

["sc-b","sc-g","sc-t","st-b","st-g","st-t","obc-b","obc-g","obc-t","gen-b","gen-g","gen-t","tb","tg","tt"]
.forEach(c=>{
grand.querySelector("."+c).innerText=
(pre?n(pre.querySelector("."+c)):0)+(pri?n(pri.querySelector("."+c)):0);
});
}

document.addEventListener("input",calc);

document.addEventListener("keydown",e=>{
if(e.key==="Enter"){
let c=[...document.querySelectorAll(".edit")];
let i=c.indexOf(document.activeElement);
if(i>-1){e.preventDefault();if(c[i+8])c[i+8].focus();}
}
});

async function makePDF(mode){
document.activeElement.blur();
document.getElementById("pdfArea").classList.add("pdfmode");
document.querySelectorAll(".delcell,.delcol").forEach(e=>e.classList.add("hidepdf"));

const canvas=await html2canvas(document.getElementById("pdfArea"),{scale:2});
const img = canvas.toDataURL("image/jpeg", 1);

const {jsPDF}=window.jspdf;
const pdf=new jsPDF("p","mm","a4");

const m=10,w=210-m*2,h=canvas.height*w/canvas.width;
pdf.addImage(img,"PNG",m,m,w,h);

document.getElementById("pdfArea").classList.remove("pdfmode");
document.querySelectorAll(".delcell,.delcol").forEach(e=>e.classList.remove("hidepdf"));

const fname=getFileName()+".pdf";

if(mode==="download") pdf.save(fname);
else{
const blob=pdf.output("blob");
navigator.share?
navigator.share({files:[new File([blob],fname,{type:"application/pdf"})]}):
pdf.save(fname);
}
}

function saveData(){
localStorage.setItem("goshwara_data",document.getElementById("pdfArea").innerHTML);
document.getElementById("saveBtn").style.display="none";
}

function resetForm(){
localStorage.removeItem("goshwara_data");
document.getElementById("resetBtn").style.display="none";
location.reload();
}

window.addEventListener("load",()=>{
let d=localStorage.getItem("goshwara_data");
if(d){
document.getElementById("pdfArea").innerHTML=d;
attachCalc();
}
});

function attachCalc(){
document.querySelectorAll(".edit").forEach(e=>e.addEventListener("input",calc));
calc();
}
</script>

</body>
</html>